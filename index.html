<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인생 파노라마 스튜디오</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&display=swap');
        
        body { 
          font-family: 'Pretendard', sans-serif;
          background-color: #2c2a29;
        }
        .font-myeongjo { font-family: 'Nanum Myeongjo', serif; }

        /* Hide the file input but keep it accessible */
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Modal transitions */
        .modal {
            display: none;
            opacity: 0;
            transition: opacity 300ms ease-in-out;
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-[#2c2a29] min-h-screen text-[#e3d9c6] p-4 sm:p-8 flex flex-col items-center">

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center my-8">
             <h1 class="text-5xl sm:text-6xl font-myeongjo font-bold">인생 파노라마 스튜디오</h1>
             <p class="text-gray-400 mt-4 text-lg">어릴 적 사진 한 장으로 당신의 미래를 그려보세요</p>
        </header>
  
        <main id="main-content" class="w-full">
            <!-- Initial Upload and API Key Section -->
            <div id="upload-section">
                <div class="w-full p-8 sm:p-12 bg-black/20 border border-gray-700 rounded-lg text-center backdrop-blur-sm">
                    <div id="image-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <h2 class="text-xl font-semibold mt-4 text-gray-300">미래 여행을 시작할 어릴 적 사진을 올려주세요</h2>
                        <p class="text-gray-500 mt-2">JPG, PNG 파일을 선택해주세요</p>
                    </div>
                    <div id="image-preview-container" class="hidden">
                        <img id="image-preview" src="" alt="업로드된 원본" class="max-w-full max-h-80 mx-auto rounded-md object-contain">
                    </div>

                    <label for="image-upload" id="upload-label" class="mt-6 inline-block bg-[#e3d9c6] text-[#2c2a29] font-semibold py-2 px-6 rounded-md shadow-md hover:bg-white/80 transition-colors cursor-pointer">
                        사진 선택하기
                    </label>
                    <input id="image-upload" type="file" accept="image/*" class="hidden-file-input">
                </div>
  
                <div class="w-full max-w-2xl mx-auto mt-8">
                    <label for="api-key" class="block text-md font-semibold text-gray-400">Google Gemini API Key</label>
                    <input type="password" id="api-key" class="mt-2 block w-full px-3 py-2 bg-black/20 border border-gray-700 rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:ring-[#e3d9c6] focus:border-[#e3d9c6] sm:text-sm" placeholder="AI-로 시작하는 API 키를 여기에 입력하세요">
                   <p class="mt-2 text-sm text-gray-500 text-right">
                    API 키가 없으신가요? <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="font-medium text-[#e3d9c6] hover:underline">여기서 발급받으세요.</a>
                  </p>
                </div>
                
                <div id="generate-button-container" class="text-center mt-8 hidden">
                    <button id="generate-button" class="bg-[#8a6e50] text-white font-bold py-3 px-12 rounded-lg shadow-lg hover:bg-[#a18666] transition-all duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-700 disabled:text-gray-500 disabled:shadow-none disabled:transform-none disabled:cursor-not-allowed flex items-center justify-center text-lg mx-auto">
                      미래 모습 생성하기
                    </button>
                </div>
            </div>
            
            <!-- Error and Loading Section -->
            <div id="error-message" class="hidden text-center my-4 p-3 bg-red-900/50 text-red-300 rounded-lg max-w-2xl mx-auto"></div>
            <div id="spinner" class="hidden w-full flex justify-center items-center mt-12">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="animate-spin text-[#e3d9c6]">
                    <path d="M21 6v.397a5 5 0 0 1-2.418 4.349l-2.01 1.256a5 5 0 0 0-2.572 4.342V21"></path><path d="M3 18v-.397a5 5 0 0 1 2.418-4.349l2.01-1.256a5 5 0 0 0 2.572-4.342V3"></path><path d="M3 6h18"></path><path d="M3 18h18"></path>
                </svg>
            </div>
  
            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div class="text-center border-b border-gray-700 pb-8 mb-10">
                    <h2 class="text-4xl font-myeongjo font-bold">인생 파노라마</h2>
                    <p class="text-gray-400 mt-2">AI가 그려본 당신의 미래 모습입니다.</p>
                    <div class="flex justify-center items-center gap-4 mt-6">
                        <button id="download-all-button" class="bg-green-600/80 text-white font-semibold py-2 px-5 rounded-md shadow-md hover:bg-green-500 transition-colors">모두 저장하기</button>
                        <button id="reset-button" class="bg-gray-700/80 text-white font-semibold py-2 px-5 rounded-md shadow-md hover:bg-gray-600 transition-colors">새로 시작하기</button>
                    </div>
                </div>
                <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                  <!-- Generated images will be injected here -->
                </div>
            </div>
        </main>
    </div>
  
    <!-- Image Modal -->
    <div id="image-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center z-50">
        <div class="relative bg-black/50 p-2 sm:p-4 rounded-lg shadow-2xl max-w-[90vw] max-h-[90vh]">
            <img id="modal-image" src="" alt="확대된 이미지" class="max-w-full max-h-[85vh] object-contain rounded-md">
            <button id="modal-close-button" class="absolute -top-4 -right-4 sm:top-2 sm:right-2 text-white bg-black/60 rounded-full p-1 hover:bg-white/20 transition-colors" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let originalImage = null; // { file, base64 }
    let generatedImages = [];
    let isGenerating = false;
    let apiKey = '';

    // --- DOM ELEMENTS ---
    const imageUploadInput = document.getElementById('image-upload');
    const uploadLabel = document.getElementById('upload-label');
    const imagePlaceholder = document.getElementById('image-placeholder');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const apiKeyInput = document.getElementById('api-key');
    const generateButtonContainer = document.getElementById('generate-button-container');
    const generateButton = document.getElementById('generate-button');
    const errorMessageDiv = document.getElementById('error-message');
    const spinner = document.getElementById('spinner');
    const uploadSection = document.getElementById('upload-section');
    const resultsSection = document.getElementById('results-section');
    const resultsGrid = document.getElementById('results-grid');
    const downloadAllButton = document.getElementById('download-all-button');
    const resetButton = document.getElementById('reset-button');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalCloseButton = document.getElementById('modal-close-button');


    // --- CONSTANTS ---
    const LIFE_STAGES = [
      { name: "10대", prompt: "A highly realistic photograph of the person from the original image, aged up to be in their late teens (around 18 years old). Their core facial features, ethnicity, and gender must be preserved. A high school graduation or early university style portrait with a bright, hopeful expression. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
      { name: "20대", prompt: "A highly realistic photograph of the person from the original image, aged up to be in their mid-20s. Their core facial features, ethnicity, and gender must be preserved. A candid photo of a young professional or traveler, looking confident in contemporary fashion. The setting could be a modern city street. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
      { name: "30대", prompt: "A highly realistic photograph of the person from the original image, aged up to be in their mid-30s. Their core facial features, ethnicity, and gender must be preserved. A professional or warm family environmental portrait, showing confidence and maturity. The lighting should be natural and flattering. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
      { name: "40대", prompt: "A highly realistic, relaxed photograph of the person from the original image, aged up to be in their mid-40s. Their core facial features, ethnicity, and gender must be preserved. They are enjoying a hobby or a casual social gathering, looking comfortable and content. The style should be natural and lifestyle-oriented. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
      { name: "50대", prompt: "A highly realistic, dignified portrait of the person from the original image, aged up to be in their mid-50s. Their core facial features, ethnicity, and gender must be preserved. They look accomplished and wise. The setting is a nice home or office. The focus is on their character and expression. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
      { name: "70대", prompt: "A highly realistic, warm, and heartwarming photograph of the person from the original image, aged up to be in their 70s. Their core facial features, ethnicity, and gender must be preserved. They have laugh lines and a gentle, happy expression, perhaps enjoying a peaceful retirement hobby. The lighting is soft and warm. The photo should look like it was taken with a modern digital camera. The image must not contain any text or letters." },
    ];

    // --- UI UPDATE FUNCTIONS ---
    const showError = (message) => {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
    };
    const clearError = () => {
        errorMessageDiv.textContent = '';
        errorMessageDiv.classList.add('hidden');
    };
    const updateGenerateButtonState = () => {
        generateButton.disabled = isGenerating || !apiKey || !originalImage;
    };
    const renderResultsGrid = () => {
        resultsGrid.innerHTML = '';
        generatedImages.forEach((image, index) => {
            const card = document.createElement('div');
            card.className = "bg-black/20 rounded-md shadow-lg transition-all duration-300 ease-in-out hover:shadow-2xl hover:shadow-black/50 hover:-translate-y-2 group border border-gray-800 flex flex-col";
            
            const imageContainerContent = 
                image.status === 'completed' ? `<img src="${image.src}" alt="${image.name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" style="transform: scaleX(1.1)">` :
                image.status === 'failed' ? `<div class="text-red-400 p-4 text-center">생성 실패</div>` :
                `<div class="w-full h-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin text-gray-500"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg></div>`;

            card.innerHTML = `
                <div class="w-full h-72 bg-black rounded-t-md flex items-center justify-center overflow-hidden ${image.status === 'completed' ? 'cursor-pointer' : ''}" data-index="${index}">
                    ${imageContainerContent}
                </div>
                <div class="p-3 flex-grow flex flex-col justify-between">
                    <h3 class="font-semibold text-center text-md text-gray-300 mb-3">${image.name}</h3>
                    <button 
                        data-index="${index}"
                        class="w-full bg-gray-700/80 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-gray-600 transition-colors disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed flex items-center justify-center gap-2 download-button"
                        ${image.status !== 'completed' ? 'disabled' : ''}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>저장하기</span>
                    </button>
                </div>
            `;
            resultsGrid.appendChild(card);
        });
    };

    // --- CORE LOGIC FUNCTIONS ---
    const handleImageChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            clearError();
            const reader = new FileReader();
            reader.onloadend = () => {
                originalImage = { file: file, base64: reader.result };
                imagePreview.src = originalImage.base64;
                imagePlaceholder.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
                uploadLabel.textContent = '다른 사진 선택';
                generateButtonContainer.classList.remove('hidden');
                updateGenerateButtonState();
            };
            reader.readAsDataURL(file);
        }
    };

    const getBase64Data = (dataUrl) => dataUrl.split(',')[1];

    const generateImageAPI = async (userApiKey, prompt, base64ImageData, retries = 3, delay = 1000) => {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${userApiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
            generationConfig: { responseModalities: ['IMAGE'] },
        };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return generateImageAPI(userApiKey, prompt, base64ImageData, retries - 1, delay * 2);
                }
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API 요청 실패: ${response.status}`);
            }
            const result = await response.json();
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            if (!base64Data) throw new Error("API 응답에서 이미지 데이터를 찾을 수 없습니다.");
            return `data:image/png;base64,${base64Data}`;
        } catch (err) {
            console.error(`Error generating image for prompt "${prompt}":`, err);
            showError(`이미지 생성 오류: ${err.message}`);
            return null;
        }
    };

    const handleGenerateClick = async () => {
        if (!originalImage || !apiKey) {
            showError("사진을 선택하고 API 키를 입력해주세요.");
            return;
        }

        isGenerating = true;
        updateGenerateButtonState();
        clearError();
        uploadSection.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        generatedImages = LIFE_STAGES.map(style => ({ name: style.name, status: 'loading', src: null }));
        renderResultsGrid(); // Show loading spinners in cards
        resultsSection.classList.remove('hidden');
        spinner.classList.add('hidden'); // Hide main spinner, use card spinners

        const originalBase64Data = getBase64Data(originalImage.base64);
        
        const generationPromises = LIFE_STAGES.map((style, index) =>
            generateImageAPI(apiKey, style.prompt, originalBase64Data).then(src => {
                generatedImages[index] = { name: style.name, status: src ? 'completed' : 'failed', src: src };
                renderResultsGrid(); // Re-render the grid to update the specific card
            })
        );

        await Promise.all(generationPromises);
        isGenerating = false;
        updateGenerateButtonState();
    };

    const handleDownload = (imageSrc, filename) => {
        if (!imageSrc) return;
        const link = document.createElement('a');
        link.href = imageSrc;
        link.download = `${filename.replace(/\s/g, '_')}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const handleDownloadAll = async () => {
        if (typeof window.JSZip === 'undefined') {
            showError("다운로드 라이브러리를 불러오는 중입니다. 잠시 후 다시 시도해주세요.");
            return;
        }
        const zip = new window.JSZip();
        const imagePromises = generatedImages
            .filter(img => img.status === 'completed')
            .map(async (img) => {
                const response = await fetch(img.src);
                const blob = await response.blob();
                zip.file(`${img.name.replace(/\s/g, '_')}.png`, blob);
            });
        await Promise.all(imagePromises);
        zip.generateAsync({ type: "blob" }).then((content) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "인생파노라마_결과물.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    };

    const handleReset = () => {
        originalImage = null;
        generatedImages = [];
        isGenerating = false;
        
        imageUploadInput.value = ''; // Reset file input
        imagePreview.src = '';
        imagePlaceholder.classList.remove('hidden');
        imagePreviewContainer.classList.add('hidden');
        uploadLabel.textContent = '사진 선택하기';
        
        resultsSection.classList.add('hidden');
        uploadSection.classList.remove('hidden');
        generateButtonContainer.classList.add('hidden');
        
        clearError();
        updateGenerateButtonState();
    };

    // --- EVENT LISTENERS ---
    imageUploadInput.addEventListener('change', handleImageChange);
    apiKeyInput.addEventListener('input', (e) => {
        apiKey = e.target.value;
        clearError();
        updateGenerateButtonState();
    });
    generateButton.addEventListener('click', handleGenerateClick);
    resetButton.addEventListener('click', handleReset);
    downloadAllButton.addEventListener('click', handleDownloadAll);

    // Event delegation for results grid
    resultsGrid.addEventListener('click', (e) => {
        const target = e.target;
        const downloadBtn = target.closest('.download-button');
        if (downloadBtn) {
            const index = downloadBtn.dataset.index;
            const image = generatedImages[index];
            if (image && image.status === 'completed') {
                handleDownload(image.src, image.name);
            }
            return;
        }

        const imageContainer = target.closest('[data-index]');
        if (imageContainer) {
             const index = imageContainer.dataset.index;
             const image = generatedImages[index];
             if (image && image.status === 'completed') {
                modalImage.src = image.src;
                imageModal.classList.add('show');
             }
        }
    });

    // Modal listeners
    modalCloseButton.addEventListener('click', () => imageModal.classList.remove('show'));
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            imageModal.classList.remove('show');
        }
    });
});
</script>

</body>
</html>


